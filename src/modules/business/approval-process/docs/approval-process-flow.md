# 결재 승인 관련 로직 흐름

결재(협의·결재·시행·참조)가 어떻게 진행되는지, 일반적인 말로 순서대로 정리한 문서입니다.

---

## 1. 전체 구조

결재 요청이 들어오면 아래 순서로 처리됩니다.

1. **요청 받기**  
   API에서 결재 승인·반려·협의 완료 같은 요청을 받습니다.

2. **트랜잭션 안에서 처리**  
   DB에 여러 번 저장하는 작업은 한 묶음(트랜잭션)으로 처리해, 중간에 실패하면 모두 되돌립니다.

3. **실제 결재 로직 실행**  
   결재 단계 조회, 권한·순서 검증, 승인/반려 처리, 문서 상태 변경을 합니다.

4. **알림 보내기**  
   처리 결과를 알림으로 보내는 일은 트랜잭션이 끝난 뒤 비동기로 합니다.

문서 상태는 **임시저장 → 결재 진행 중 → 결재 완료 → 시행 완료** 순으로 바뀌고, 반려나 취소 시에는 **반려** 또는 **취소** 상태가 됩니다.  
결재 단계 종류는 **협의 → 결재 → 시행 → 참조** 순서입니다.

---

## 2. 결재 승인 (미결재 단계에서 승인하기)

**순서:**

1. 사용자가 “이 결재 단계를 승인한다”고 요청할 때, 그 결재 단계 번호와 선택적으로 의견을 보냅니다.
2. 서버는 로그인한 사람이 결재자인지 확인하고, 결재자와 요청자가 같은 사람인지 봅니다.
3. 해당 결재 단계를 DB에서 찾습니다.
4. **정책 확인**:  
   - 문서가 “결재 진행 중” 상태인지,  
   - 이 단계가 “결재” 단계(협의가 아님)인지,  
   - 이 단계가 아직 “대기” 상태인지 확인합니다.
5. **순서 확인**:  
   결재선에는 협의와 결재가 하나의 순서 값으로 섞여 있을 수 있습니다 (예: 결재1 → 협의2 → 협의3 → 결재4 → 결재5).  
   따라서 **내 단계보다 앞선 순서 값**을 가진 모든 단계(협의든 결재든)가 먼저 승인되었는지 확인합니다.  
   순서 값과 단계 종류를 가지고 “앞선 단계가 모두 완료되었는지”만 검증하면 됩니다.
6. 위가 모두 맞으면, 해당 결재 단계를 “승인” 처리하고 저장합니다. 코멘트(의견)는 요청에 값이 있으면 해당 값을, 없으면 기본값을 저장합니다.
7. 이 문서의 **모든 협의와 모든 결재**가 승인되었는지 봅니다.  
   - 모두 완료되었으면 문서 상태를 “결재 완료”로 바꿉니다.  
   - 아직 남은 결재가 있으면 문서 상태는 “결재 진행 중”으로 둡니다.
8. 처리가 끝나면 승인 알림을 보냅니다.

---

## 3. 협의 완료 (협의 단계에서 승인하기)

협의 단계는 “문서 번호 + 지금 로그인한 사람이 협의자”로 찾습니다.  
다만 **순서는 결재와 함께 하나의 줄**로 보므로, 내 순서보다 앞선 모든 단계가 완료된 뒤에만 협의를 처리할 수 있습니다.

**순서:**

1. 사용자가 “이 문서의 협의를 완료한다”고 요청할 때, 문서 번호와 선택적으로 의견을 보냅니다.
2. 서버는 로그인한 사람이 그 문서의 협의자 중 한 명인지 확인합니다.
3. 해당 문서에서 “협의” 단계이면서, 요청한 사람이 결재자(협의자)인 단계를 DB에서 찾습니다.
4. **정책 확인**:  
   - 문서가 “결재 진행 중”인지,  
   - 그 단계가 아직 “대기” 상태인지 확인합니다.
5. **순서 확인**:  
   결재선의 순서 값과 단계 종류를 기준으로, **이 협의 단계보다 앞선 순서**에 있는 모든 단계(협의·결재 모두)가 이미 승인되었는지 확인합니다.  
   (예: 결재1 → 협의2 → 협의3 → 결재4 이면, 협의3을 처리하려면 결재1, 협의2가 먼저 완료되어 있어야 합니다.)
6. 맞으면 그 협의 단계를 “승인” 처리하고 저장합니다. 코멘트(의견)는 요청에 값이 있으면 해당 값을, 없으면 기본값을 저장합니다.
7. 이 문서의 **모든 협의와 모든 결재**가 승인되었는지 봅니다.  
   모두 완료되었으면 문서 상태를 “결재 완료”로 바꿉니다.  
   (협의가 마지막 단계인 경우에도, 그 협의를 완료했을 때 위 조건이 맞으면 문서는 “결재 완료”로 바뀝니다.)
8. 처리가 끝나면 협의 완료 알림을 보냅니다.

---

## 4. 협의 반려

협의 단계에서 반려할 때는 문서 번호와 반려 사유를 보냅니다. 서버는 문서 번호와 로그인한 사람(협의자)으로 해당 협의 단계를 찾습니다. 반려 사유는 필수입니다.

**순서:**

1. 사용자가 “이 문서의 협의를 반려한다”고 요청할 때, 문서 번호와 반려 사유를 보냅니다.
2. 서버는 해당 문서의 협의 단계를 찾은 뒤, **로그인한 사람이 그 단계의 결재자(협의자)인지** 확인합니다. 본인이 아닐 경우 반려할 수 없습니다.
3. **정책 확인**:  
   - 문서가 “결재 진행 중”인지,  
   - 그 단계가 “대기” 상태인지,  
   - 반려 사유가 비어 있지 않은지 확인합니다.
4. 맞으면 그 단계를 “반려” 처리하고, 문서도 “반려” 상태로 바꾼 뒤 저장합니다. 코멘트(반려 사유)는 요청에 값이 있으면 해당 값을, 없으면 기본값을 의견으로 저장합니다.
5. 처리가 끝나면 반려 알림을 보냅니다.

---

## 5. 결재 반려 (특정 결재 단계를 반려하기)

결재(또는 협의) 단계에서 반려할 때는 결재 단계 번호와 반려 사유를 보냅니다. 서버는 그 단계 번호로 해당 결재 단계를 찾습니다. 반려 사유는 필수입니다.

**순서:**

1. 사용자가 “이 결재 단계를 반려한다”고 요청할 때, 결재 단계 번호와 반려 사유를 보냅니다.
2. 서버는 해당 결재 단계를 찾은 뒤, **로그인한 사람이 그 단계의 결재자(또는 협의자)인지** 확인합니다. 본인이 아닐 경우 반려할 수 없습니다.
3. **정책 확인**:  
   - 문서가 “결재 진행 중”인지,  
   - 그 단계가 “대기” 상태인지,  
   - 반려 사유가 비어 있지 않은지 확인합니다.
4. 맞으면 그 단계를 “반려” 처리하고, 문서도 “반려” 상태로 바꾼 뒤 저장합니다. 코멘트(반려 사유)는 요청에 값이 있으면 해당 값을, 없으면 기본값을 의견으로 저장합니다.
5. 처리가 끝나면 반려 알림을 보냅니다.

---

## 6. 시행 완료

시행은 **문서가 “결재 완료” 상태일 때만** 할 수 있습니다.

**순서:**

1. 사용자가 “이 시행 단계를 완료했다”고 요청할 때, 시행 단계 번호와 선택적으로 의견·결과 데이터를 보냅니다.
2. 서버는 해당 시행 단계를 DB에서 찾습니다.
3. **정책·권한 확인**:  
   - 문서가 “결재 완료” 상태인지,  
   - 로그인한 사람이 그 시행 단계의 시행자인지,  
   - 그 단계가 “대기” 상태인지 확인합니다.
4. 맞으면 그 시행 단계를 “승인” 처리하고, 문서 상태를 “시행 완료”로 바꾼 뒤 저장합니다. 코멘트(의견)·결과는 요청에 값이 있으면 해당 값을, 없으면 기본값을 저장합니다.
5. 처리가 끝나면 시행 완료 알림을 보냅니다.

---

## 7. 참조 열람 확인

참조 열람은 **문서 상태와 상관없이** 해당 참조 단계의 참조자라면 언제든 할 수 있습니다.

**순서:**

1. 사용자가 “이 참조 문서를 열람했다”고 요청할 때, 참조 단계 번호와 선택적으로 의견을 보냅니다.
2. 서버는 해당 참조 단계를 찾은 뒤, **로그인한 사람이 그 단계의 참조자인지** 확인합니다. 본인이 아닐 경우 열람 확인할 수 없습니다.
3. **정책 확인**:  
   - 그 단계가 “대기” 상태이면 “열람 완료”로 처리하고, 이미 열람 완료된 단계면 그대로 둡니다.
4. 처리할 내용이 있으면 그 단계를 “열람 완료” 처리한 뒤 저장합니다. 코멘트(의견)는 요청에 값이 있으면 해당 값을, 없으면 기본값을 저장합니다.

---

## 8. 결재 취소

본인이 **승인한** 결재 단계만 취소할 수 있고, **그 다음 순서의 단계가 아직 아무도 처리하지 않았을 때만** 취소할 수 있습니다.  
문서 상태가 **“반려”**이면 결재 취소는 할 수 없습니다.

결재 취소 시에는 **본인의 그 결재 단계만** “승인”에서 “대기”로 되돌립니다.  
이때 **기안자(1결재자)**가 취소하는 경우와 **그 밖의 결재자**가 취소하는 경우를 나눕니다.

---

### 8-1. 일반 결재자가 결재 취소하는 경우

본인이 마지막 결재자여서 문서가 “결재 완료” 상태였더라도, 본인 단계를 “대기”로 되돌리면 **문서 상태도 “결재 진행 중”으로** 다시 바꿉니다.

**순서:**

1. 사용자가 “이 결재를 취소한다”고 요청할 때, 취소할 결재 단계 번호와 선택적으로 사유를 보냅니다.
2. 서버는 해당 결재 단계를 찾은 뒤, **로그인한 사람이 그 단계의 결재자인지** 확인합니다. 본인이 아닐 경우 취소할 수 없습니다.
3. **정책 확인**:  
   - 문서가 “반려” 상태가 **아닌지** 확인합니다. (반려된 문서는 결재 취소 불가.)  
   - 문서가 “결재 진행 중” 또는 “결재 완료”인지 확인합니다.  
   - 그 단계가 이미 “승인” 상태인지,  
   - 그 다음 순서의 단계는 아직 아무도 처리하지 않았는지 확인합니다.
4. 맞으면 **해당 결재 단계만** “승인” → “대기”로 되돌려 저장합니다.  
   - 본인이 마지막 결재자여서 문서가 “결재 완료”였으면, 문서 상태를 “결재 진행 중”으로 바꿉니다.  
   - 코멘트(사유)는 요청에 값이 있으면 해당 값을, 없으면 기본값을 의견으로 저장합니다.

---

### 8-2. 기안자(1결재자)가 결재 취소하는 경우

문서를 기안한 사람은 **1결재자로 고정**되어 있고, 상신하자마자 1결재자 단계가 자동으로 “승인” 처리됩니다.  
**기안자(1결재자)**가 결재 취소를 하면, 그 단계를 “대기”로 되돌리는 동시에 **상신 자체를 취소**합니다.  
그래서 문서 상태는 **“취소”**가 되고, 문서는 더 이상 결재 진행이 아닌 “상신 취소된 문서”가 됩니다.

**순서:**

1. 사용자가 “이 결재를 취소한다(상신을 취소한다)”고 요청할 때, 취소할 결재 단계 번호(1결재자 단계)와 선택적으로 사유를 보냅니다.
2. 서버는 해당 결재 단계를 찾은 뒤, **로그인한 사람이 그 단계의 결재자인지**, 그리고 **기안자(1결재자)인지** 확인합니다.
3. **정책 확인**:  
   - 문서가 “반려” 상태가 **아닌지** 확인합니다.  
   - 문서가 “결재 진행 중”인지,  
   - 그 단계가 이미 “승인” 상태인지,  
   - 그 다음 순서의 단계는 아직 아무도 처리하지 않았는지 확인합니다.
4. 맞으면 해당 결재 단계를 “승인” → “대기”로 되돌리고, **문서 상태를 “취소”로** 바꾼 뒤 저장합니다. 코멘트(사유)는 요청에 값이 있으면 해당 값을, 없으면 기본값을 의견으로 저장합니다.

---

## 9. 상신취소 (기안자용)

**결재 취소**와 별도로, **상신취소**는 **기안자**가 본인이 기안한 문서의 상신을 취소하는 기능입니다.  
문서가 **“결재 진행 중”**일 때만 가능하고, **기안자만** 할 수 있습니다.  
(1결재자가 기안자인 경우, “결재 취소”를 쓰면 상신까지 취소되므로 같은 결과가 됩니다. 상신취소는 기안자 전용 API로 문서만 지정해 상신을 취소할 때 사용합니다.)

**순서:**

1. 사용자가 “이 문서의 상신을 취소한다”고 요청할 때, 문서 번호와 선택적으로 사유를 보냅니다.
2. 서버는 해당 문서를 찾은 뒤, **로그인한 사람이 그 문서의 기안자인지** 확인합니다. 기안자가 아닐 경우 상신취소할 수 없습니다.
3. **정책 확인**:  
   - 문서가 “결재 진행 중” 상태인지 확인합니다. (다른 상태면 상신취소 불가.)
4. 맞으면 문서 상태를 “취소”로 바꾼 뒤 저장합니다. 코멘트(사유)는 요청에 값이 있으면 해당 값을, 없으면 기본값을 의견으로 저장합니다.

---

## 10. 정책 정리 (언제 무엇을 할 수 있는지)

### 10.1 문서 상태별로 수신자가 할 수 있는 일

| 단계 종류 | 허용되는 문서 상태        | 허용되는 행동                         |
|-----------|---------------------------|----------------------------------------|
| 협의      | 결재 진행 중              | 승인(협의 완료), 반려                 |
| 결재      | 결재 진행 중              | 승인, 반려, 결재 취소                 |
| 시행      | 결재 완료                 | 시행 완료                             |
| 참조      | 문서 상태 무관            | 열람 확인                             |

즉,  
- 협의·결재는 “결재 진행 중”일 때만 승인/반려할 수 있고,  
- 시행은 “결재 완료”일 때만 할 수 있으며,  
- 참조는 문서 상태와 상관없이 해당 참조자라면 언제든 열람 확인할 수 있습니다.

### 10.2 결재선 순서 (협의·결재 모두 적용)

- 결재선에는 **순서 값**이 있고, 협의와 결재가 한 줄로 섞여 있을 수 있습니다.  
  예: 결재1 → 협의2 → 협의3 → 결재4 → 결재5.
- **어떤 단계를 처리할 때나**(협의 완료이든 결재 승인이든) **순서 값**과 **단계 종류**를 사용해 검증합니다.  
  즉, **내 순서보다 앞선 순서**를 가진 모든 단계(협의든 결재든)가 먼저 승인되어 있어야, 그 다음 단계를 처리할 수 있습니다.
- 따라서 “모든 협의 먼저, 그다음 결재”가 아니라, **정해진 순서 값대로** 앞 단계부터 차례대로 완료하는 방식입니다.

### 10.3 문서 상태가 바뀌는 시점

- **결재 진행 중 → 결재 완료**  
  해당 문서의 모든 협의와 모든 결재가 승인되었을 때, (결재 승인 처리 후) 문서 상태가 “결재 완료”로 바뀝니다.
- **결재 완료 → 시행 완료**  
  해당 문서의 모든 시행 단계가 완료되었을 때, 문서 상태가 “시행 완료”로 바뀝니다.
- **반려**  
  협의 또는 결재에서 반려가 나면, 그 시점에 문서 상태가 “반려”로 바뀝니다.
- **취소**  
  **기안자**가 **상신취소**를 하거나, **기안자(1결재자)**가 **결재 취소**를 하면 상신이 취소되어 문서 상태가 “취소”로 바뀝니다.
- **결재 완료 → 결재 진행 중**  
  **일반 결재자**가 본인이 승인한 결재를 취소할 때, 본인이 마지막 결재자였으면 문서 상태가 “결재 완료”에서 “결재 진행 중”으로 되돌아갑니다.

### 10.4 상신취소·결재 취소 조건

- **상신취소**: 문서가 **“결재 진행 중”**일 때만 가능하고, **기안자만** 할 수 있습니다. 기안자가 상신취소하면 문서 상태가 “취소”로 바뀝니다.
- **결재 취소**: **문서가 “반려” 상태**이면 결재 취소를 할 수 없습니다.
- 본인이 **이미 승인한** 결재 단계만 취소할 수 있고, **그 다음 순서의 단계는 아직 아무도 처리하지 않았을 때**만 취소할 수 있습니다.
- **기안자(1결재자)**가 결재 취소를 하면: 해당 단계를 “대기”로 되돌리고, **상신 취소**까지 되어 문서가 “취소” 상태가 됩니다.
- **그 밖의 결재자**가 결재 취소를 하면: 해당 단계만 “대기”로 되돌립니다. 본인이 마지막 결재자였으면 문서 상태는 “결재 진행 중”으로 되돌아갑니다.

---

## 11. 결재선/템플릿 설정 시 검증

결재선이나 템플릿을 만들 때는 “어떤 단계에 어떤 할당 규칙을 쓸 수 있는지”를 따로 검증합니다.

- **협의**: 지정한 사람 한 명만 가능(고정).
- **결재**: 고정 결재자, 기안자, 기안자 상급자, 특정 직책까지 등 여러 규칙 사용 가능.
- **시행**: 고정 시행자 또는 기안자.
- **참조**: 고정 참조자 또는 부서 전체 참조.

이 검증은 **결재선을 설계할 때** 쓰이고, 실제로 “승인/반려 버튼 눌렀을 때”의 흐름에서는 **문서 정책 검증**(위 10번)이 사용됩니다.

---

## 12. 문서와 결재 단계가 가진 상태 (요약)

- **문서**  
  임시저장 → 결재 진행 중 → 결재 완료 → 시행 완료.  
  중간에 반려되면 “반려”, 취소되면 “취소”가 됩니다.
- **각 결재 단계(협의/결재/시행/참조)**  
  대기 → 승인 또는 반려(또는 취소).  
  승인하면 “승인” 상태, 반려하면 “반려” 상태로 기록됩니다.

---

## 13. 결재 승인 한 줄 요약 (순서)

1. 요청으로 “어느 결재 단계”인지 받는다.  
2. 로그인한 사람이 그 단계의 결재자인지 확인한다.  
3. 문서가 결재 진행 중인지, 그 단계가 대기 상태인지, 결재 단계(협의 아님)인지 확인한다.  
4. **순서 값**을 기준으로, 이 단계보다 **앞선 순서**에 있는 모든 단계(협의·결재 모두)가 승인되었는지 확인한다.  
5. 위가 모두 맞으면 그 단계를 승인 처리하고 저장한다.  
6. 이 문서의 모든 협의·결재가 끝났으면 문서를 “결재 완료”로 바꾼다.  
7. 끝나면 알림을 보낸다.
